
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>Mockk Test - Espresso Kotlin Playground</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mockk-test" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Espresso Kotlin Playground" class="md-header__button md-logo" aria-label="Espresso Kotlin Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Espresso Kotlin Playground
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Mockk Test
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/plusmobileapps/espresso-kotlin-playground" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Espresso Kotlin Playground" class="md-nav__button md-logo" aria-label="Espresso Kotlin Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Espresso Kotlin Playground
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/plusmobileapps/espresso-kotlin-playground" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../page-object-pattern/" class="md-nav__link">
        Page Object Pattern
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../espresso-extensions/" class="md-nav__link">
        Espresso Extensions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../navigation-dsl/" class="md-nav__link">
        Navigation DSL
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Mockk Test
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Mockk Test
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mockk-test-setup" class="md-nav__link">
    MockK Test Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-a-login-error-test" class="md-nav__link">
    Write a Login Error Test
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-android-pie-api-28-mocking" class="md-nav__link">
    Pre Android Pie (API 28) mocking
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source" class="md-nav__link">
    Source
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mock-ktor-test/" class="md-nav__link">
        Mock Ktor Test
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../integrate-with-api/" class="md-nav__link">
        Integrate With API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../jetpack-compose/" class="md-nav__link">
        Jetpack Compose
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../google-maps/" class="md-nav__link">
        Google Maps
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mockk-test-setup" class="md-nav__link">
    MockK Test Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-a-login-error-test" class="md-nav__link">
    Write a Login Error Test
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-android-pie-api-28-mocking" class="md-nav__link">
    Pre Android Pie (API 28) mocking
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source" class="md-nav__link">
    Source
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/plusmobileapps/espresso-kotlin-playground/edit/master/docs/mockk-test.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="mockk-test">Mockk Test</h1>
<p>The first strategy to discuss when it comes to mock testing in Android is replacing a dependency in the app with a mock using <a href="https://mockk.io/">Mockk</a>. With this approach, it helps to look at a diagram of the app architecture to better understand what is actually being tested and what can be controlled with a mock. To try to maximize the test coverage of the app and control the source of data, the <code>LoginDataSource</code> is what will be replaced with a mock to ensure consistent test data. </p>
<p><img alt="" src="../img/login-mockk.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One could just as easily replace the <code>LoginRepository</code> or the <code>LoginViewModel</code> with a mock in a test, however consider what the test itself is actually testing when replacing layers of the architecture at a higher level. This sort of approach might be more feasible if there is confidence in the unit test coverage in the repository or ViewModel, although mocking the network source is usually the best approach to test the integration of every layer in an app.</p>
</div>
<h2 id="mockk-test-setup">MockK Test Setup</h2>
<p>To setup the project for a Mockk test, a dependency injection framework such as <a href="https://dagger.dev/hilt/">Hilt</a> will be helpful to easily swap out dependencies in the app with mocks. Since the purpose of this tutorial is not to deep dive into Hilt or Mockk, the setup of Hilt can be found in this <a href="https://github.com/plusmobileapps/espresso-kotlin-playground/commit/cd65d50fea1760c966f6ba7f571bf2cdcd26592a">commit</a> and Mockk simply requires this one line in the app <code>build.gradle</code>. </p>
<div class="highlight"><pre><span></span><code><span class="n">androidTestImplementation</span> <span class="s2">&quot;io.mockk:mockk-android:1.12.0&quot;</span>
</code></pre></div>
<h2 id="write-a-login-error-test">Write a Login Error Test</h2>
<p>To start writing a Hilt Espresso test, we need to add the <code>@HiltAndroidTest</code> annotation to the test class and declare a Hilt rule. </p>
<div class="highlight"><pre><span></span><code><span class="nd">@HiltAndroidTest</span>
<span class="kd">class</span> <span class="nc">MockkLoginTest</span> <span class="p">{</span>

    <span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
    <span class="kd">var</span> <span class="nv">hiltRule</span> <span class="o">=</span> <span class="n">HiltAndroidRule</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

<span class="p">}</span>
</code></pre></div>
<p>Now to override the <code>LoginDataSource</code> with a mockk, we can declare a mock as a property and annotate with the <code>@JvmField</code> and <code>@BindValue</code> to override the mock in the dependency graph.  </p>
<div class="highlight"><pre><span></span><code><span class="nd">@BindValue</span>
<span class="nd">@JvmField</span>
<span class="kd">val</span> <span class="nv">loginDataSource</span><span class="p">:</span> <span class="n">LoginDataSource</span> <span class="o">=</span> <span class="n">mockk</span><span class="p">(</span><span class="n">relaxed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
</code></pre></div>
<p>Finally in a test, the data source can be mocked out with an error response and validates the user is shown the error. </p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span> <span class="nf">errorLogin</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="nv">expectedError</span> <span class="o">=</span> <span class="s">&quot;Something bad happened&quot;</span>
    <span class="n">every</span> <span class="p">{</span> <span class="n">loginDataSource</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}</span> <span class="n">returns</span> <span class="n">Result</span><span class="p">.</span><span class="na">Error</span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">expectedError</span><span class="p">))</span> 
    <span class="kd">val</span> <span class="nv">scenario</span> <span class="o">=</span> <span class="n">launchActivity</span><span class="o">&lt;</span><span class="n">LoginActivity</span><span class="o">&gt;</span><span class="p">()</span>

    <span class="n">startOnPage</span><span class="o">&lt;</span><span class="n">LoginPage</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">enterInfo</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
        <span class="n">onSignInOrRegisterButton</span><span class="p">().</span><span class="na">click</span><span class="p">()</span>
        <span class="n">onErrorMessage</span><span class="p">().</span><span class="na">verifyText</span><span class="p">(</span><span class="n">expectedError</span><span class="p">).</span><span class="na">verifyVisible</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">scenario</span><span class="p">.</span><span class="na">close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>This is pretty much the basis for writing an Espresso mock test with Mockk. So if you were to update the successful login test, how would you rewrite the other login test to return something dynamic? </p>
<ol>
<li>enter info on the login page and submit</li>
<li>verify the welcome greeting display name</li>
<li>verify navigation to the settings</li>
</ol>
<details class="answer">
<summary>Answer</summary>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span> <span class="nf">successfulLogin</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">every</span> <span class="p">{</span> <span class="n">loginDataSource</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}</span> <span class="n">returns</span> <span class="n">Result</span><span class="p">.</span><span class="na">Success</span><span class="p">(</span><span class="n">LoggedInUser</span><span class="p">(</span><span class="s">&quot;some-user-id&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">))</span> 
    <span class="kd">val</span> <span class="nv">scenario</span> <span class="o">=</span> <span class="n">launchActivity</span><span class="o">&lt;</span><span class="n">LoginActivity</span><span class="o">&gt;</span><span class="p">()</span>

    <span class="n">startOnPage</span><span class="o">&lt;</span><span class="n">LoginPage</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">enterInfo</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="p">}.</span><span class="na">goToLoggedInPage</span> <span class="p">{</span>
        <span class="n">onWelcomeGreeting</span><span class="p">().</span><span class="na">verifyText</span><span class="p">(</span><span class="s">&quot;Welcome </span><span class="si">$</span><span class="n">displayName</span><span class="s">!&quot;</span><span class="p">)</span>
    <span class="p">}.</span><span class="na">goToSettings</span><span class="p">()</span>

    <span class="n">scenario</span><span class="p">.</span><span class="na">close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<ul>
<li><a href="https://github.com/plusmobileapps/espresso-kotlin-playground/commit/f9e55f2b8f0f8c6bddf0a4158e6d463df9d668fb">Add mockk and mock tests commit</a> - contains all the code for tests added in this section</li>
</ul>
<h2 id="pre-android-pie-api-28-mocking">Pre Android Pie (API 28) mocking</h2>
<p>Up until this point the app will run fine on Android P and above, however there are some limitations to Mockk mocking final classes in Espresso before that. Running the test on an emulator lower than API 28 will result in the following error caused by the mocking call. </p>
<p><img alt="" src="../img/mockk-exception.png" /></p>
<p>If you are writing an Android app that has a minimum SDK less than Android P and need to mock a final class in a test. The recommended approach on the <a href="https://mockk.io/ANDROID.html">Mockk Android</a> page is to use <a href="https://github.com/tmurakami/dexopener">Dexopener</a>, however if you look on the project readme you will see: </p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>DexOpener will do the following things at runtime:</p>
<ol>
<li>Remove the final modifier from the classes belonging to the specified package</li>
<li>Create dex files to make the application class loader load those classes</li>
</ol>
<p>However, they are not so lightweight. If you would like to save even a little testing time of your Kotlin app, you can introduce <a href="https://kotlinlang.org/docs/reference/compiler-plugins.html#all-open-compiler-plugin">the all-open compiler plugin</a> instead of DexOpener.</p>
</div>
<p>So to keep the mock tests as performant as possible we will use the <a href="https://kotlinlang.org/docs/all-open-plugin.html">Kotlin all open compiler</a> which will only open up classes marked with an annotation on debug builds. The first thing to use the all open compiler is to create an annotation class which can then be used to mark classes desired to be opened for testing.</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span> <span class="nn">com.plusmobileapps.kotlinopenespresso</span>

<span class="kd">annotation</span> <span class="kd">class</span> <span class="nc">OpenForTest</span>
</code></pre></div>
<p>Now that there is an annotation class to mark tests for open, the open compiler dependencies need to be added to the project and instructed which annotation should be used to know which classes to open. </p>
<div class="highlight"><pre><span></span><code><span class="c1">// root build.gradle</span>
<span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span> <span class="s2">&quot;org.jetbrains.kotlin:kotlin-allopen:$kotlin_version&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// app build.gradle</span>
<span class="n">allOpen</span> <span class="o">{</span>
    <span class="n">annotation</span><span class="o">(</span><span class="s2">&quot;com.plusmobileapps.kotlinopenespresso.OpenForTest&quot;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
<p>At last mark the final class needing to be mocked with the new annotation and the test should now run on pre Android P devices!</p>
<div class="highlight"><pre><span></span><code><span class="nd">@OpenForTest</span>
<span class="kd">class</span> <span class="nc">LoginDataSource</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">()</span> <span class="p">{}</span>
</code></pre></div>
<ul>
<li><a href="https://github.com/plusmobileapps/espresso-kotlin-playground/commit/8c2bbe3ba0d167d8eb8f8d02d6fee3caa263681d">Add Kotlin all open compiler commit</a></li>
</ul>
<hr />
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Mockk tests are a good start for writing some mock Espresso tests, however this approach does completely swap out the implementation detail of <code>LoginDataSource</code>. If you looked more closely at all the changes, you might have noticed that the implementation of <code>LoginDataSource</code> is actually still returning a hardcoded display name. This was intentional to showcase that this approach does have some short comings because the test passes however in production it is not yet quite dynamic. The next section will explain another approach to mock testing that will simply mock the network traffic in the test to fully test the integration of everything in the app.  </p>
</div>
<h2 id="source">Source</h2>
<ul>
<li><a href="https://github.com/plusmobileapps/espresso-kotlin-playground/tree/5-mockk-test"><code>5-mockk-test</code> branch</a></li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../navigation-dsl/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Navigation DSL" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Navigation DSL
            </div>
          </div>
        </a>
      
      
        
        <a href="../mock-ktor-test/" class="md-footer__link md-footer__link--next" aria-label="Next: Mock Ktor Test" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Mock Ktor Test
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
    
  </body>
</html>